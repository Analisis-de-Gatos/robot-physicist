name: Quarto Publish (Físico Remoto CI/CD)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      # Paso 1: Checkout del código fuente
      - name: Checkout del Repositorio
        uses: actions/checkout@v4

      # Paso 2: Instalar Python correctamente
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Paso 3: Instalar Quarto (sin python-version)
      - name: Instalar Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.4.550

      # Paso 4: Instalar dependencias
      - name: Instalar dependencias
        run: pip install -r requirements.txt

      # Paso 5: Clonar extensión Quarto marimo manualmente
      - name: Clonar extensión Quarto marimo
        run: |
          mkdir -p _extensions/marimo-team
          git clone https://github.com/marimo-team/quarto-marimo.git _extensions/marimo-team/quarto-marimo

      # Paso 6: Renderizar sitio Quarto
      - name: Renderizar sitio Quarto
        run: cd robot-physicist-website && quarto render

      # Paso 7: Validar generación de HTML
      - name: Validar generación de HTML
        run: |
          if ls robot-physicist-website/site/*.html; then
            echo "Archivos HTML generados correctamente."
          else
            echo "ERROR: No se generaron los archivos HTML." && exit 1
          fi

      # Paso 8: Subir artefactos a GitHub Pages
      - name: Subir artefactos a GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: robot-physicist-website/site

      # Paso 9: Desplegar a GitHub Pages
      - name: Desplegar a GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
